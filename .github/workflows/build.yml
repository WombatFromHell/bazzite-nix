name: Build Custom Image

on:
  schedule:
    - cron: "1 6 * * 1,3,5" # 06:01 UTC (Mon/Wed/Fri)
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build even if digest unchanged"
        required: false
        default: false
        type: boolean
      skip_rechunk:
        description: "Skip rechunk step (faster build, larger layers)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: write
  id-token: write

env:
  # Image metadata
  IMAGE_NAME: "${{ github.event.repository.name }}"
  IMAGE_DESC: "Customized Bazzite image with Nix mount support and other sugar"
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"

  # Variant configuration file path
  # Edit .github/variants.json to add, remove, or modify build variants
  VARIANTS_CONFIG: ".github/variants.json"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Check upstream images, determine which variants need rebuilding, and aggregate results
  check_and_aggregate:
    uses: ./.github/workflows/check.yml
    with:
      force_build: ${{ github.event.inputs.force_build == 'true' }}
      variants_config: ".github/variants.json"

  # Build, sign, and push each variant that needs updating
  build_push:
    needs: check_and_aggregate
    if: needs.check_and_aggregate.outputs.any_builds_needed == 'true'
    uses: ./.github/workflows/push.yml
    with:
      variants_to_build: ${{ needs.check_and_aggregate.outputs.variants_to_build }}
      date: ${{ needs.check_and_aggregate.outputs.date }}
      registry_lower: ${{ needs.check_and_aggregate.outputs.registry }}
      repo: ${{ needs.check_and_aggregate.outputs.repo }}
      image_desc: ${{ needs.check_and_aggregate.outputs.image_desc }}
      skip_rechunk: ${{ github.event.inputs.skip_rechunk == 'true' }}
    secrets:
      signing_secret: ${{ secrets.SIGNING_SECRET }}
